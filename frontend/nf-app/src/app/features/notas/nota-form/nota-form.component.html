<mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>
<div class="nota-form-container">
  <h2>Nova Nota Fiscal</h2>

  <form [formGroup]="form" class="nota-form">
    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Número da Nota</mat-label>
      <input matInput formControlName="numero" [disabled]="true" />
    </mat-form-field>

    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Status</mat-label>
      <input matInput formControlName="status" [disabled] = "true" />
    </mat-form-field>

    <div class="itens-header">
      <h3>Itens da Nota</h3>
      <button mat-mini-fab color="primary" type="button" (click)="adicionarItem()">
        <mat-icon>add</mat-icon>
      </button>
    </div>

<div [formGroup]="form"> 
    <table mat-table [dataSource]="itens.controls" class="mat-elevation-z2 full-width" formArrayName="itens">

        <ng-container matColumnDef="produto">
            <th mat-header-cell *matHeaderCellDef>Produto</th>
            <td mat-cell *matCellDef="let item; let i = index" [formGroupName]="i">
                <mat-form-field appearance="outline" class="full-width">
                    <mat-select formControlName="produtoId" placeholder="Selecione o Produto">
                        <mat-option *ngFor="let p of produtos" [value]="p.id">
                            {{ p.descricao }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </td>
        </ng-container>

        <ng-container matColumnDef="quantidade">
            <th mat-header-cell *matHeaderCellDef>Qtd</th>
            <td mat-cell *matCellDef="let item; let i = index" [formGroupName]="i">
                <mat-form-field appearance="outline" class="quantidade">
                    <input matInput type="number" formControlName="quantidade" min="1" />
                </mat-form-field>
            </td>
        </ng-container>

        <ng-container matColumnDef="acoes">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let item; let i = index">
                <button mat-icon-button color="warn" (click)="removerItem(i)">
                    <mat-icon>delete</mat-icon>
                </button>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

        <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [attr.colspan]="displayedColumns.length">
                Nenhum item adicionado à nota. Clique em "Adicionar Item".
            </td>
        </tr>
    </table>
</div>

    <div class="actions">
        <button mat-button (click)="fechar()">Cancelar</button>
      <button mat-flat-button color="primary" (click)="salvar()">Salvar Nota</button>
    </div>
  </form>
</div>
